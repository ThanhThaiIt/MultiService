<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JwtUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">multiservice</a> &gt; <a href="index.source.html" class="el_package">com.example.multiservice.utils</a> &gt; <span class="el_source">JwtUtils.java</span></div><h1>JwtUtils.java</h1><pre class="source lang-java linenums">package com.example.multiservice.utils;

import java.text.ParseException;
import java.time.Instant;
import java.time.temporal.ChronoUnit;
import java.util.*;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;
import org.springframework.util.CollectionUtils;

import com.example.multiservice.entity.PermissionEntity;
import com.example.multiservice.entity.UserEntity;
import com.example.multiservice.exception.AppException;
import com.example.multiservice.exception.enums.ErrorStatusCode;
import com.example.multiservice.repository.InvalidateTokenRepository;
import com.example.multiservice.repository.PermissionRepository;
import com.nimbusds.jose.*;
import com.nimbusds.jose.crypto.MACSigner;
import com.nimbusds.jose.crypto.MACVerifier;
import com.nimbusds.jwt.JWTClaimsSet;
import com.nimbusds.jwt.SignedJWT;

import lombok.AccessLevel;
import lombok.RequiredArgsConstructor;
import lombok.experimental.FieldDefaults;
import lombok.experimental.NonFinal;

@Component
@RequiredArgsConstructor
@FieldDefaults(level = AccessLevel.PRIVATE, makeFinal = true)
public class JwtUtils {
<span class="fc" id="L35">    private static final Logger log = LoggerFactory.getLogger(JwtUtils.class);</span>

    @NonFinal // marking to do not let Inject vào Contructor
    @Value(&quot;${jwt.expiration-time}&quot;)
    long EXPIRATION_TIME; // 1 p

    @NonFinal // marking to do not let Inject vào Contructor
    @Value(&quot;${jwt.secret.key}&quot;)
    protected String SECRET_KEY;

    @NonFinal // marking to do not let Inject vào Contructor
    @Value(&quot;${jwt.refreshable-duration}&quot;)
    protected long REFRESHABLE_DURATION;

    PermissionRepository permissionRepository;

    InvalidateTokenRepository invalidateTokenRepository;

    public String generateToken(UserEntity userEntity) {

<span class="nc" id="L55">        log.info(&quot;token generation started &quot; + SECRET_KEY);</span>

<span class="nc" id="L57">        JWSHeader jwsHeader = new JWSHeader(JWSAlgorithm.HS512); // Type Of Algorithm</span>
<span class="nc" id="L58">        JWTClaimsSet jwtClaimsSet = new JWTClaimsSet.Builder()</span>
<span class="nc" id="L59">                .subject(userEntity.getEmail())</span>
<span class="nc" id="L60">                .issuer(&quot;multiservice.com&quot;) // who issue</span>
<span class="nc" id="L61">                .issueTime(new Date())</span>
<span class="nc" id="L62">                .expirationTime(new Date(</span>
<span class="nc" id="L63">                        Instant.now().plus(EXPIRATION_TIME, ChronoUnit.SECONDS).toEpochMilli()))</span>
<span class="nc" id="L64">                .jwtID(UUID.randomUUID().toString()) // 32 character randomly</span>
<span class="nc" id="L65">                .claim(&quot;scope&quot;, buildScopes(userEntity))</span>
<span class="nc" id="L66">                .build();</span>

<span class="nc" id="L68">        Payload payload = new Payload(jwtClaimsSet.toJSONObject());</span>

<span class="nc" id="L70">        JWSObject jwsObject = new JWSObject(jwsHeader, payload);</span>
        try {
<span class="nc" id="L72">            jwsObject.sign(new MACSigner(SECRET_KEY.getBytes()));</span>
<span class="nc" id="L73">            return jwsObject.serialize(); // serialize into string</span>
<span class="nc" id="L74">        } catch (JOSEException e) {</span>
<span class="nc" id="L75">            log.error(&quot;Can not create JWT object&quot;, e);</span>
<span class="nc" id="L76">            throw new RuntimeException(e);</span>
        }
    }

    // purpose: will return &quot;SignedJWT&quot; if token is valid,
    // signature(digital signature) is valid,
    // not in invalidatetoken table (token is logged out)
    public SignedJWT verifyToken(String token, boolean isRefresh) throws JOSEException, ParseException {

        // Initialize JWSVerifier to verify signature with secret key
<span class="nc" id="L86">        JWSVerifier verifier = new MACVerifier(SECRET_KEY.getBytes());</span>

        // Parse the token into a SignedJWT object
<span class="nc" id="L89">        SignedJWT signedJWT = SignedJWT.parse(token);</span>

        // get expire time from token return true false
<span class="nc bnc" id="L92" title="All 2 branches missed.">        Date expirationTime = (isRefresh)</span>
<span class="nc" id="L93">                ? new Date(signedJWT</span>
<span class="nc" id="L94">                        .getJWTClaimsSet()</span>
<span class="nc" id="L95">                        .getIssueTime()</span>
<span class="nc" id="L96">                        .toInstant()</span>
<span class="nc" id="L97">                        .plus(REFRESHABLE_DURATION, ChronoUnit.SECONDS)</span>
<span class="nc" id="L98">                        .toEpochMilli())</span>
<span class="nc" id="L99">                : signedJWT.getJWTClaimsSet().getExpirationTime();</span>

<span class="nc bnc" id="L101" title="All 6 branches missed.">        if (expirationTime != null &amp;&amp; expirationTime.before(new Date()) &amp;&amp; isRefresh) {</span>
<span class="nc" id="L102">            throw new AppException(ErrorStatusCode.JWT_EXPIRED_REFRESH);</span>
        }

<span class="nc bnc" id="L105" title="All 4 branches missed.">        if (expirationTime != null &amp;&amp; expirationTime.before(new Date())) {</span>
<span class="nc" id="L106">            throw new AppException(ErrorStatusCode.TOKEN_EXPIRED);</span>
        }

        // available function
        // return true or false: true if is correct token  and vice versa
<span class="nc" id="L111">        boolean verified = signedJWT.verify(verifier);</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">        if (!verified) {</span>
<span class="nc" id="L113">            throw new AppException(ErrorStatusCode.UNAUTHENTICATED);</span>
        }

<span class="nc bnc" id="L116" title="All 4 branches missed.">        if (invalidateTokenRepository.existsById(signedJWT.getJWTClaimsSet().getJWTID()) &amp;&amp; isRefresh) {</span>
<span class="nc" id="L117">            throw new AppException(ErrorStatusCode.JWT_LOGOUT_REFRESH);</span>
        }

<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (invalidateTokenRepository.existsById(signedJWT.getJWTClaimsSet().getJWTID())) {</span>
<span class="nc" id="L121">            throw new AppException(ErrorStatusCode.UNAUTHENTICATED);</span>
        }

<span class="nc" id="L124">        return signedJWT;</span>
    }

    // The business here is that we will have a parameter as a UserEntity and in this entity there will be 1
    // ListRoles and each Role will have many Permissions, we will go through each element  to concatenate
    // the string and distinguish between Role and Permission as &quot;ROLE_&quot;
    private String buildScopes(UserEntity userEntity) {
<span class="nc" id="L131">        StringJoiner scopes = new StringJoiner(&quot; &quot;);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (!CollectionUtils.isEmpty(userEntity.getRoles())) {</span>
<span class="nc" id="L133">            userEntity.getRoles().forEach(roleEntity -&gt; {</span>
<span class="nc" id="L134">                scopes.add(&quot;ROLE_&quot; + roleEntity.getTitle());</span>

<span class="nc" id="L136">                var permissions = getPermissions(roleEntity.getId());</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">                if (!CollectionUtils.isEmpty(permissions)) {</span>
<span class="nc" id="L138">                    permissions.forEach(permissionEntity -&gt; {</span>
<span class="nc" id="L139">                        scopes.add(permissionEntity.getSlug());</span>
<span class="nc" id="L140">                    });</span>
                }
<span class="nc" id="L142">            });</span>
        }
<span class="nc" id="L144">        return scopes.toString();</span>
    }

    private List&lt;PermissionEntity&gt; getPermissions(int roleId) {

<span class="nc" id="L149">        List&lt;PermissionEntity&gt; permissionEntities = permissionRepository.findPermissionsByRoleId(roleId);</span>

<span class="nc" id="L151">        return permissionEntities;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>